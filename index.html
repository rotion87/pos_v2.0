<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <title>å­¤èŠ³å°éšŠ GOODFUN TEAM ãƒ»é–‹æºæ”¶éŠ€ç³»çµ±</title>
  <meta name="theme-color" content="#001080">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="dos.css">

  <!-- å½ˆå‡ºè¦–çª—ï¼†æ„Ÿè¬è¦–çª—æ¨£å¼ï¼‹æ”¾å¤§çµå¸³æ¡†ï¼‹å¯†ç¢¼è¦–çª—ï¼‹footer -->
  <style>
  #thanks-modal{
    position:fixed; inset:0; display:none; place-items:center;
    background:rgba(0,0,0,.55); z-index:9999;
  }
  #thanks-modal.show{ display:grid; }
  .thanks-box{
    background:var(--panel2);
    border:3px solid var(--border);
    box-shadow: inset 0 0 8px #000a, 0 6px 18px rgba(0,0,0,.4);
    padding:14px; max-width:90vw; width:min(640px, 96vw);
    animation:pop .16s ease-out;
  }
  .thanks-inner{
    border:2px solid var(--border2);
    background:var(--panel);
    padding:16px;
    text-align:center;
  }
  .thanks-img{ width:100%; height:auto; image-rendering:pixelated; }
  .thanks-text{ margin-top:10px; font-size:22px; color:var(--text); }

  /* æ„Ÿè¬ç•«é¢ä¸­çš„è³¼è²·å“é …åˆ—è¡¨ */
  .thanks-items{
    margin-top:12px;
    text-align:left;
    font-size:18px;
    max-height:40vh;
    overflow:auto;
  }
  .thanks-items ul{
    margin:4px 0 0;
    padding-left:20px;
  }

  /* çµå¸³çµæœè¦–çª— */
  #result{
    position:fixed;
    inset:0;
    display:grid;
    place-items:center;
    background:rgba(0,0,0,.65);
    z-index:9000;
  }
  #result.hidden{
    display:none;
  }
  .result-box{
    background:var(--panel2);
    border:3px solid var(--border);
    box-shadow: inset 0 0 8px #000a, 0 6px 18px rgba(0,0,0,.4);
    padding:18px;
    width:min(640px, 96vw);
  }
  .result-inner{
    border:2px solid var(--border2);
    background:var(--panel);
    padding:18px 22px;
  }

  .bigbox .bigtext{ font-size:34px; }

  /* æ­·å²é ï¼šæ—¥æœŸ */
  .history-day-header{
    margin:10px 0 4px;
    padding:4px 2px;
    border-bottom:1px solid #fff;
    font-weight:bold;
  }

  /* ===== è¨­å®šå¯†ç¢¼ DOS è¦–çª— ===== */
  #pw-modal{
    position:fixed;
    inset:0;
    display:none;
    place-items:center;
    background:rgba(0,0,0,.7);
    z-index:10000;
  }
  #pw-modal.show{
    display:grid;
  }
  .pw-box{
    background:var(--panel2);
    border:3px solid var(--border);
    box-shadow: inset 0 0 8px #000a, 0 6px 18px rgba(0,0,0,.5);
    padding:14px;
    width:min(420px, 96vw);
    animation:pop .16s ease-out;
  }
  .pw-inner{
    border:2px solid var(--border2);
    background:var(--panel);
    padding:16px 18px;
    color:var(--text);
    font-family:'LanaPixel','Press Start 2P','Noto Sans TC',monospace;
    font-size:18px;
    line-height:1.6;
  }
  .pw-title{
    font-size:20px;
    margin-bottom:8px;
  }
  .pw-input-row{
    margin:10px 0;
    display:flex;
    align-items:center;
    gap:8px;
  }
  #pw-input{
    flex:1;
    background:#000030;
    border:1px solid var(--border);
    color:var(--white);
    border-radius:4px;
    padding:6px 8px;
    font-family:'LanaPixel','Noto Sans TC',monospace;
    font-size:18px;
  }
  #pw-error{
    margin-top:4px;
    min-height:1.2em;
    font-size:14px;
    color:#ff5a5a;
  }
  .pw-actions{
    margin-top:14px;
    display:flex;
    justify-content:flex-end;
    gap:8px;
  }

  /* åº•éƒ¨å›ºå®šç‰ˆæ¬Šåˆ—ï¼ˆé»‘åº• DOS é¢¨æ ¼ï¼‰ */
  #footer-bar{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    padding:4px 8px 6px;
    background:var(--panel2);
    border-top:1px solid var(--border2);
    font-size:14px;
    text-align:center;
    color:var(--text);
    z-index:8000;
  }

  @keyframes pop{ from{ transform:scale(.92); opacity:.6 } to{ transform:scale(1); opacity:1 } }
  </style>
</head>

<body>
  <!-- éŸ³æ•ˆ -->
  <audio id="ding" src="ding.wav" preload="auto"></audio>
  <audio id="key" src="ding.wav" preload="auto"></audio>
  <audio id="enterSound" src="enter.wav" preload="auto"></audio>
  <audio id="enterFinal" src="enterFinal.wav" preload="auto"></audio>

  <div class="topline vga">
    <div id="clock">--:--:--</div>
    <div id="today-stats">ä»Šæ—¥éŠ·å”®ï¼š0 ç­†ï¼NT$ 0</div>

    <!-- è¨­å®šæŒ‰éˆ•ï¼ˆå«å‡º DOS å¯†ç¢¼è¦–çª—ï¼‰ -->
    <button id="btn-settings" style="margin-left:8px">è¨­å®š</button>

    <button id="btn-history" style="margin-left:8px">æ­·å²</button>
    <button id="btn-fs" style="margin-left:8px">å…¨è¢å¹•</button>
  </div>

  <div id="app" class="wrap">
    <!-- å•†å“é  -->
    <section id="page-products" class="page active">
      <div class="sum-bar vga">
        åˆè¨ˆé‡‘é¡ï¼š<span id="sum-top">NT$ 0</span>
      </div>

      <ul id="prod-list" class="prod-list"></ul>

      <div class="bar actions">
        <button id="btn-subtotal" class="primary">å°è¨ˆ â†’</button>
      </div>
    </section>

    <!-- ä»˜æ¬¾é  -->
    <section id="page-pay" class="page">
      <div class="sum-bar vga">
        åˆè¨ˆé‡‘é¡ï¼š<span id="sum-pay">NT$ 0</span>
      </div>

      <div class="pay-box">
        <label>è¼¸å…¥æ”¶ç¾é‡‘é‡‘é¡ï¼š</label>
        <input id="cash-input" type="number" inputmode="numeric" placeholder="è¼¸å…¥é‡‘é¡">
        <div class="quick">
          <button data-cash="exact">å‰›å¥½</button>
          <button data-cash="100">+100</button>
          <button data-cash="500">+500</button>
          <button data-cash="1000">+1000</button>
        </div>

        <div class="bar">
          <button id="btn-back">è¿”å›</button>
          <button id="btn-confirm" class="primary">ç¢ºå®š</button>
        </div>
      </div>
    </section>

    <!-- æ­·å²é  -->
    <section id="page-history" class="page">
      <div class="sum-bar vga">æ­·å²è³¼è²·ç´€éŒ„</div>

      <div class="dos-frame tight">
        <div class="dos-inner">
          <div class="bar" style="justify-content:space-between;margin-bottom:10px; gap:10px; align-items:flex-start; flex-wrap:wrap;">
            <div>
              <div id="history-summary" class="vga">å…± 0 ç­†ï¼åˆè¨ˆ NT$ 0</div>
              <div class="vga" style="margin-top:4px;">
                æ—¥æœŸç¯©é¸ï¼š
                <input id="history-date" type="date">
                <button id="btn-date-clear">å…¨éƒ¨</button>
              </div>
            </div>
            <div>
              <button id="btn-export">åŒ¯å‡º CSV</button>
              <button id="btn-clear-all">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
              <button id="btn-h-back" class="primary">è¿”å›ä¸»é </button>
            </div>
          </div>

          <ul id="history-list" style="list-style:none;padding:0;margin:0"></ul>
        </div>
      </div>
    </section>

    <!-- è¨­å®šé ï¼ˆå¯†ç¢¼é€šéå¾Œæ‰é€²ï¼‰ -->
    <section id="page-settings" class="page">
      <div class="sum-bar vga">ç³»çµ±è¨­å®š</div>

      <div class="dos-frame tight">
        <div class="dos-inner vga" style="font-size:18px;line-height:1.6;">
          <!-- åº—å -->
          <div class="settings-section-title">åº—å®¶è³‡è¨Š</div>
          <div style="margin-bottom:12px;">
            <label>åº—åï¼š
              <input id="set-store-name" type="text" style="width:100%;max-width:420px;margin-left:4px;">
            </label>
          </div>

          <!-- å•†å“ -->
          <div class="settings-section-title">å•†å“åˆ—è¡¨</div>
          <div class="settings-note">ï¼ˆä¾åºé¡¯ç¤ºåœ¨ä¸»é ï¼Œå¯æ–°å¢æˆ–åˆªé™¤ï¼Œè‡³å°‘éœ€è¦ä¸€å€‹å•†å“ï¼‰</div>
          <div id="set-products"></div>
          <div style="margin-top:6px;">
            <button id="btn-add-product" type="button">ï¼‹ æ–°å¢å•†å“</button>
          </div>

          <!-- æ„Ÿè¬ç•«é¢ -->
          <div class="settings-section-title" style="margin-top:18px;">çµå¸³æ„Ÿè¬ç•«é¢</div>
          <div style="margin-bottom:10px;">
            <label>æ„Ÿè¬æ–‡å­—ï¼š
              <input id="set-thanks-text" type="text" style="width:100%;max-width:420px;margin-left:4px;" placeholder="è¬è¬æ‚¨çš„å…‰é¡§ï¼Œæ­¡è¿ä¸‹æ¬¡å†ä¾†ï¼">
            </label>
          </div>
          <div style="margin-bottom:8px;">
            <label>ä¸Šå‚³æ„Ÿè¬åœ–ç‰‡ï¼š
              <input id="set-thanks-img" type="file" accept="image/*">
            </label>
          </div>
          <div style="margin-bottom:8px;font-size:14px;">
            ï¼ˆç³»çµ±æœƒè‡ªå‹•å°‡åœ–ç‰‡è½‰æˆåƒç´ åŒ– 8-bits æ•ˆæœï¼‰
          </div>

          <canvas id="thanks-canvas" style="display:none;"></canvas>

          <div style="margin-top:4px;">
            <img id="thanks-preview" class="thanks-img" src="S__67870744.png" alt="æ„Ÿè¬ç•«é¢é è¦½">
          </div>

          <div class="bar" style="justify-content:flex-end;margin-top:16px;">
            <button id="btn-settings-cancel" type="button">å–æ¶ˆ</button>
            <button id="btn-settings-save" type="button" class="primary">å„²å­˜è¨­å®š</button>
          </div>
        </div>
      </div>
    </section>
  </div>
  <!-- çµå¸³çµæœè¦–çª—ï¼šåªæœ‰ æ”¶æ¬¾ / åˆè¨ˆ / æ‰¾å› -->
  <div id="result" class="result hidden">
    <div class="result-box dos-frame bigbox">
      <div class="result-inner dos-inner bigtext">
        <div class="row vga"><span>æ”¶ã€€æ¬¾ï¼š</span><span id="r-receive">0</span><span> å…ƒ</span></div>
        <div class="row vga"><span>åˆã€€è¨ˆï¼š</span><span id="r-total">0</span><span> å…ƒ</span></div>
        <div class="row vga"><span>æ‰¾ã€€å›ï¼š</span><span id="r-change">0</span><span> å…ƒ</span></div>
        <div id="r-deficit" class="deficit hidden vga" style="margin-top:10px">
          é‡‘é¡ä¸è¶³ï¼šé‚„å·® <b id="r-short">0</b> å…ƒ
        </div>

        <div class="bar" style="justify-content:flex-end;margin-top:16px">
          <button id="btn-finish" class="primary" disabled>å®Œæˆçµå¸³ (Enter)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å®Œæˆçµå¸³å¾Œçš„æ„Ÿè¬è¦–çª—ï¼ˆå«è³¼è²·æ¸…å–®ï¼‰ -->
  <div id="thanks-modal" role="dialog" aria-modal="true">
    <div class="thanks-box">
      <div class="thanks-inner">
        <img id="thanks-img" class="thanks-img" src="S__67870744.png" alt="æ„Ÿè¬å…‰è‡¨">
        <div id="thanks-text" class="thanks-text vga">è¬è¬æ‚¨çš„å…‰é¡§ï¼Œæ­¡è¿ä¸‹æ¬¡å†ä¾†ï¼</div>

        <!-- é¡¯ç¤ºæœ¬æ¬¡è³¼è²·çš„å“é …æ¸…å–® -->
        <div id="thanks-items" class="thanks-items vga"></div>

        <div class="bar" style="justify-content:center; margin-top:10px">
          <button id="thanks-close" class="primary">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¨­å®šå¯†ç¢¼ DOS è¦–çª— -->
  <div id="pw-modal" role="dialog" aria-modal="true">
    <div class="pw-box">
      <div class="pw-inner">
        <div class="pw-title">ç³»çµ±è¨­å®šãƒ»æ¬Šé™é©—è­‰</div>
        <div>è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼æ‰èƒ½é€²å…¥ã€Œè¨­å®šã€ç•«é¢ã€‚</div>

        <div class="pw-input-row">
          <span>å¯†ç¢¼ï¼š</span>
          <input id="pw-input" type="password" inputmode="numeric" maxlength="8" autocomplete="off">
        </div>

        <div id="pw-error"></div>

        <div class="pw-actions">
          <button id="pw-cancel">å–æ¶ˆ</button>
          <button id="pw-ok" class="primary">ç¢ºèª</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨ç‰ˆæ¬Šåˆ— -->
  <div id="footer-bar" class="vga">
    Copyright Â© 2025 å­¤èŠ³å°éšŠ GOODFUN TEAM ï½œMake it fun, get it good.
  </div>

  <div id="toast" class="toast"></div>

  <!-- Script -->
  <script>
  // ====== åŸºæœ¬è¨­å®šï¼šåº—åï¼å•†å“ï¼æ„Ÿè¬ç•«é¢ ======
  const SETTINGS_PASSWORD = '5487'; // ğŸ” è¨­å®šå¯†ç¢¼

  const DEFAULT_STORE_NAME = 'å­¤èŠ³è”¬æœæ”¤ GOODFUN GROCERY';
  const STORE_KEY       = 'pos.storeName';
  const PROD_KEY        = 'pos.products';
  const THANKS_IMG_KEY  = 'pos.thanksImg';
  const THANKS_TEXT_KEY = 'pos.thanksText';

  // é è¨­å•†å“æ¸…å–®
  const DEFAULT_PRODUCTS = [
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
    {name:'å•†å“åç¨±',                 price:999},
  ];

  function loadStoreName(){
    const s = localStorage.getItem(STORE_KEY);
    return (s && s.trim()) || DEFAULT_STORE_NAME;
  }
  function saveStoreName(name){
    localStorage.setItem(STORE_KEY, (name || '').trim());
  }

  function loadProducts(){
    try{
      const raw = localStorage.getItem(PROD_KEY);
      if(!raw) throw new Error('no products');
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr) || !arr.length) throw new Error('empty');
      return arr.map(p => ({
        name: p.name || '',
        price: Number(p.price) || 0,
        qty: 0
      })).filter(p => p.name && p.price > 0);
    }catch(e){
      return DEFAULT_PRODUCTS.map(p => ({...p, qty:0}));
    }
  }
  function saveProducts(list){
    const data = list.map(p => ({
      name: p.name,
      price: Number(p.price) || 0
    }));
    localStorage.setItem(PROD_KEY, JSON.stringify(data));
  }

  let STORE_NAME = loadStoreName();
  let PRODUCTS   = loadProducts();

  // ====== å³æ™‚å›å‚³ API ======
  const API_URL = 'https://script.google.com/macros/s/AKfycbzqYqtKLmIxa84SnOepD_2AYZ3_2UaJUX2rm8TfqXnFsJZEqbVk7OLQTXeSUegeVdA/exec';

  const el  = s => document.querySelector(s);
  const els = s => Array.from(document.querySelectorAll(s));

  function money(n){ return Number(n||0).toFixed(0); }
  function formatNT(n){ return 'NT$ ' + money(n); }

  function calcSum(){
    return PRODUCTS.reduce((s,p)=> s + p.price * (p.qty||0), 0);
  }

  // === éŸ³æ•ˆèˆ‡å…¨è¢å¹•å·¥å…· ===
  function playAudioById(id){
    try{
      const a = typeof id === 'string' ? el(id) : id;
      if(!a) return;
      a.currentTime = 0;
      a.play().catch(()=>{});
    }catch(e){}
  }

  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement);
  }
  function requestFullscreen(){
    const de = document.documentElement;
    if (de.requestFullscreen) return de.requestFullscreen();
    if (de.webkitRequestFullscreen) return de.webkitRequestFullscreen();
  }
  function exitFullscreen(){
    if (document.exitFullscreen) return document.exitFullscreen();
    if (de.webkitExitFullscreen) return document.webkitExitFullscreen();
  }
  async function toggleFullscreen(){
    if (isFullscreen()) await exitFullscreen();
    else await requestFullscreen();
  }

  // ====== å¯†ç¢¼è¦–çª—æ§åˆ¶ ======
  function showPwModal(){
    const m = el('#pw-modal');
    const input = el('#pw-input');
    const err = el('#pw-error');
    if(!m) return;
    err.textContent = '';
    input.value = '';
    m.classList.add('show');
    setTimeout(()=> input.focus(), 10);
  }

  function hidePwModal(){
    const m = el('#pw-modal');
    if(!m) return;
    m.classList.remove('show');
  }

  function handlePwSubmit(){
    const input = el('#pw-input');
    const err = el('#pw-error');
    const v = (input.value || '').trim();
    if(v === SETTINGS_PASSWORD){
      hidePwModal();
      openSettings();
    }else{
      err.textContent = 'å«ä½ å€‘è€é—†å‡ºä¾†';
    }
  }

  function isPwModalOpen(){
    const m = el('#pw-modal');
    return m && m.classList.contains('show');
  }

  // ----- åˆ—è¡¨æ¸²æŸ“èˆ‡é¸å–ç‹€æ…‹ -----
  let selectedIndex = 0;
  function renderList(){
    const ul = el('#prod-list');
    ul.innerHTML = '';
    PRODUCTS.forEach((p, idx)=>{
      const li = document.createElement('li');
      li.className = 'row prod';
      if(idx === selectedIndex) li.classList.add('active');
      li.innerHTML = `
        <span class="p-name">${p.name}</span>
        <span class="p-price vga">$${p.price}</span>
        <div class="qty">
          <button class="minus" aria-label="minus">âˆ’</button>
          <span class="q vga">${p.qty||0}</span>
          <button class="plus" aria-label="plus">ï¼‹</button>
        </div>
      `;
      li.querySelector('.minus').addEventListener('click', ()=>{
        PRODUCTS[idx].qty = Math.max(0, (PRODUCTS[idx].qty||0)-1);
        updateSumAndList(idx, li);
      });
      li.querySelector('.plus').addEventListener('click', ()=>{
        PRODUCTS[idx].qty = (PRODUCTS[idx].qty||0)+1;
        updateSumAndList(idx, li);
      });
      ul.appendChild(li);
    });
    updateSumTop();
    ensureVisible();
  }

  function updateSumAndList(idx, li){
    li.querySelector('.q').textContent = PRODUCTS[idx].qty||0;
    updateSumTop();
  }
  function updateSumTop(){
    const sum = calcSum();
    el('#sum-top').textContent = formatNT(sum);
  }

  function ensureVisible(){
    const rows = els('.row.prod');
    const active = rows[selectedIndex];
    if(active){ active.scrollIntoView({block:'nearest'}); }
  }

  function selectPrev(){
    selectedIndex = Math.max(0, selectedIndex-1);
    renderList();
  }
  function selectNext(){
    selectedIndex = Math.min(PRODUCTS.length-1, selectedIndex+1);
    renderList();
  }
  function increaseQty(){
    PRODUCTS[selectedIndex].qty = (PRODUCTS[selectedIndex].qty||0)+1;
    renderList();
  }
  function decreaseQty(){
    PRODUCTS[selectedIndex].qty = Math.max(0,(PRODUCTS[selectedIndex].qty||0)-1);
    renderList();
  }

  function onProductsPage(){ return el('#page-products').classList.contains('active'); }
  function onPayPage(){ return el('#page-pay').classList.contains('active'); }
  function onHistoryPage(){ return el('#page-history').classList.contains('active'); }
  function onSettingsPage(){ return el('#page-settings').classList.contains('active'); }

  function gotoPage(id){
    els('.page').forEach(p=> p.classList.remove('active'));
    el(id).classList.add('active');
  }

  // ====== LocalStorage ç´€éŒ„ï¼ˆéŠ·å”®ç´€éŒ„ï¼‰ ======
  const KEY = 'pos.records';
  const loadAll = () => { try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch(e){return [];} };
  const saveAll = arr => localStorage.setItem(KEY, JSON.stringify(arr));

  function sendRecordToServer(rec){
    if (!API_URL) return;
    const payload = {
      ts: rec.ts,
      pm: rec.pm,
      total: rec.total,
      received: rec.received,
      change: rec.change,
      items: rec.items
    };
    fetch(API_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(err => {
      console.log('sendRecordToServer error', err);
    });
  }

  const saveRecord = rec => {
    const all = loadAll();
    all.push(rec);
    saveAll(all);
    refreshTodayStats();
    sendRecordToServer(rec);
  };

  function resetAllQty(){
    PRODUCTS.forEach(p=> p.qty = 0);
    renderList();
  }

  // æ›´æ–°ä»Šæ—¥çµ±è¨ˆèˆ‡æ™‚é˜
  function refreshTodayStats(){
    const today = new Date().toISOString().slice(0,10);
    const list = loadAll().filter(r=> (r.ts||'').slice(0,10) === today);
    const sum = list.reduce((s,r)=> s + (r.total||0), 0);
    el('#today-stats').textContent = `ä»Šæ—¥éŠ·å”®ï¼š${list.length} ç­†ï¼${formatNT(sum)}`;
  }
  function startClock(){
    const pad = n => String(n).padStart(2,'0');
    setInterval(()=>{
      const d = new Date();
      const date = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      el('#clock').textContent = `${date} ${time}`;
    }, 500);
  }

  // ====== æ­·å²ç´€éŒ„ï¼ˆæ—¥åˆ¥ç¯©é¸ï¼‹åˆ†çµ„ï¼‰ ======
  let historyFilterDate = null;

  function fmtTime(ts){
    try{
      const d = new Date(ts);
      const pad = n => String(n).padStart(2,'0');
      const date = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      return `${date} ${time}`;
    }catch(e){ return ts || ''; }
  }

  function getDateKey(ts){
    if(!ts) return 'æœªçŸ¥æ—¥æœŸ';
    try{
      return String(ts).slice(0,10);
    }catch(e){
      return 'æœªçŸ¥æ—¥æœŸ';
    }
  }

  function renderHistory(){
    const all = loadAll();
    all.forEach((r, i)=> r._idx = i);

    let list = all;
    if(historyFilterDate){
      list = all.filter(r => getDateKey(r.ts) === historyFilterDate);
    }

    const ul = el('#history-list'); ul.innerHTML = '';
    const sum = list.reduce((s,r)=> s + (r.total||0), 0);
    el('#history-summary').textContent = `å…± ${list.length} ç­†ï¼åˆè¨ˆ ${formatNT(sum)}`;

    if(!list.length){
      const li = document.createElement('li');
      li.className = 'vga';
      li.textContent = 'ï¼ˆç›®å‰æ²’æœ‰ç´€éŒ„ï¼‰';
      ul.appendChild(li);
      return;
    }

    const groups = {};
    list.forEach(r=>{
      const key = getDateKey(r.ts);
      if(!groups[key]) groups[key] = [];
      groups[key].push(r);
    });

    const dates = Object.keys(groups).sort().reverse();

    dates.forEach(dateKey=>{
      const dayHeader = document.createElement('li');
      dayHeader.className = 'history-day-header vga';
      dayHeader.textContent = dateKey;
      ul.appendChild(dayHeader);

      const records = groups[dateKey].slice().reverse();

      records.forEach(r=>{
        const idx = r._idx;
        const li = document.createElement('li');
        li.className = 'receipt';
        li.style.marginBottom = '12px';
        const itemsText = (r.items||[]).map(it=> `${it.name} Ã— ${it.qty}`).join('ã€');

        li.innerHTML = `
          <div class="receipt-title">${fmtTime(r.ts)}</div>
          <div class="vga" style="margin:6px 0">å“é …ï¼š${itemsText || 'â€”'}</div>
          <div class="vga">åˆè¨ˆï¼š<b>${money(r.total||0)}</b> å…ƒã€€ï½œã€€æ”¶æ¬¾ï¼š${money(r.received||0)}ã€€ï½œã€€æ‰¾é›¶ï¼š${money(r.change||0)}</div>
          <div class="bar" style="justify-content:flex-end;margin-top:8px">
            <button data-del="${idx}" class="danger">åˆªé™¤</button>
          </div>
        `;
        ul.appendChild(li);
      });
    });

    ul.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const idx = Number(b.dataset.del);
        const arr = loadAll();
        arr.splice(idx, 1);
        saveAll(arr);
        renderHistory();
        refreshTodayStats();
        showToast('å·²åˆªé™¤ä¸€ç­†ç´€éŒ„');
      });
    });
  }

  function gotoHistory(){
    renderHistory();
    gotoPage('#page-history');
  }

  function setHistoryFilter(dateStr){
    historyFilterDate = dateStr || null;
    renderHistory();
  }

  // ===== åŒ¯å‡º CSV =====
  function exportCSV(){
    const all = loadAll();
    all.forEach((r, i)=> r._idx = i);

    let list = all;
    if(historyFilterDate){
      list = all.filter(r => getDateKey(r.ts) === historyFilterDate);
    }

    if(!list.length){
      showToast('ç›®å‰æ²’æœ‰ç´€éŒ„å¯ä»¥åŒ¯å‡º');
      return;
    }

    const rows = [];
    rows.push([
      'æ™‚é–“',
      'ä»˜æ¬¾æ–¹å¼',
      'åˆè¨ˆé‡‘é¡',
      'æ”¶æ¬¾é‡‘é¡',
      'æ‰¾é›¶é‡‘é¡',
      'å“é …æ˜ç´°'
    ].join(','));

    list.forEach(r=>{
      const time = fmtTime(r.ts || '');
      const pm   = r.pm || 'ç¾é‡‘';
      const total = r.total || 0;
      const received = r.received || 0;
      const change = r.change || 0;
      const itemsText = (r.items||[])
        .map(it => `${it.name}x${it.qty}`)
        .join(' / ');

      const safe = (v) => {
        const s = String(v||'');
        if(s.includes(',') || s.includes('"')){
          return '"' + s.replace(/"/g,'""') + '"';
        }
        return s;
      };

      rows.push([
        safe(time),
        safe(pm),
        safe(total),
        safe(received),
        safe(change),
        safe(itemsText)
      ].join(','));
    });

    const csv = rows.join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const base = historyFilterDate || 'all';
    a.href = url;
    a.download = `goodfun-pos-${base}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('å·²åŒ¯å‡º CSV æª”');
  }

  // ===== ä»˜æ¬¾çµæœè¦–çª— =====
  function showResultModal(sum, received){
    const change = Math.max(received - sum, 0);
    const short = Math.max(sum - received, 0);

    el('#r-total').textContent   = money(sum);
    el('#r-receive').textContent = money(received);
    el('#r-change').textContent  = money(change);

    const deficit = el('#r-deficit');
    const shortEl = el('#r-short');
    const finishBtn = el('#btn-finish');

    if(short > 0){
      shortEl.textContent = money(short);
      deficit.classList.remove('hidden');
      finishBtn.disabled = true;
    }else{
      deficit.classList.add('hidden');
      finishBtn.disabled = false;
    }

    el('#result').classList.remove('hidden');
  }

  function hideResultModal(){
    el('#result').classList.add('hidden');
  }

  // æ„Ÿè¬è¦–çª—ï¼šè³¼è²·å“é …
  function updateThanksItems(items){
    const c = el('#thanks-items');
    if(!c) return;
    c.innerHTML = '';

    const header = document.createElement('div');
    header.textContent = 'æœ¬æ¬¡è³¼è²·å…§å®¹ï¼š';
    c.appendChild(header);

    if(!items.length){
      const empty = document.createElement('div');
      empty.textContent = 'ï¼ˆæœ¬æ¬¡æœªé¸è³¼å•†å“ï¼‰';
      c.appendChild(empty);
      return;
    }

    const ul = document.createElement('ul');
    items.forEach(it=>{
      const li = document.createElement('li');
      li.textContent = `${it.name} Ã— ${it.qty}`;
      ul.appendChild(li);
    });
    c.appendChild(ul);
  }

  function showThanksModal(){
    const m = el('#thanks-modal');
    if(!m) return;
    m.classList.add('show');
  }

  function hideThanksModal(){
    const m = el('#thanks-modal');
    if(m && m.classList.contains('show')) m.classList.remove('show');
  }

  function applyThanksConfig(){
    const txtEl = el('#thanks-text');
    const imgEl = el('#thanks-img');
    const savedTxt = localStorage.getItem(THANKS_TEXT_KEY);
    const savedImg = localStorage.getItem(THANKS_IMG_KEY);
    if(savedTxt && savedTxt.trim()) txtEl.textContent = savedTxt;
    if(savedImg) imgEl.src = savedImg;
    const preview = el('#thanks-preview');
    if(preview){
      preview.src = savedImg || imgEl.src;
    }
  }

  // é€²å…¥ä»˜æ¬¾é 
  function enterPayPage(){
    const sum = calcSum();
    if(sum<=0){ showToast('ç›®å‰åˆè¨ˆç‚º 0ï¼Œè«‹å…ˆé¸æ“‡æ•¸é‡ã€‚'); return; }
    el('#sum-pay').textContent = formatNT(sum);
    el('#cash-input').value = '';
    hideResultModal();
    gotoPage('#page-pay');
  }

  // å®Œæˆçµå¸³
  function finishCheckout(){
    const sum = calcSum();
    const received = Number(el('#cash-input').value||0);
    if(received < sum){ return; }

    const change = Math.max(received - sum, 0);
    const items = PRODUCTS
      .filter(p=> (p.qty||0) > 0)
      .map(p=> ({ name:p.name, price:p.price, qty:p.qty }));

    const rec = {
      ts: new Date().toISOString(),
      pm: 'ç¾é‡‘',
      total: sum,
      received,
      change,
      items
    };
    saveRecord(rec);

    try{ playAudioById('#ding'); }catch(e){}

    resetAllQty();
    hideResultModal();

    updateThanksItems(items);
    showThanksModal();
  }

  function returnHome(){
    gotoPage('#page-products');
  }

  // Toast
  function showToast(text){
    const t = el('#toast');
    t.textContent = text || `ä»Šæ—¥éŠ·å”®ï¼š${el('#today-stats').textContent.replace('ä»Šæ—¥éŠ·å”®ï¼š','')}`;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 1500);
  }

  // ===== è¨­å®šé ï¼šè¡¨å–®è™•ç† =====
  function buildSettingsProductsForm(){
    const wrap = el('#set-products');
    if(!wrap) return;
    wrap.innerHTML = '';
    PRODUCTS.forEach((p, idx)=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.style.marginBottom = '6px';
      row.innerHTML = `
        <input type="text" class="set-p-name" data-idx="${idx}"
          value="${p.name}"
          style="flex:2;min-width:0;font-size:16px;padding:4px;">
        <input type="number" class="set-p-price" data-idx="${idx}"
          value="${p.price}"
          style="width:120px;font-size:16px;padding:4px;margin-left:6px;">
        <button type="button" class="set-p-del danger" data-idx="${idx}" style="margin-left:6px;">åˆªé™¤</button>
      `;
      wrap.appendChild(row);
    });

    wrap.querySelectorAll('.set-p-del').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = Number(btn.dataset.idx);
        PRODUCTS.splice(idx, 1);
        buildSettingsProductsForm();
      });
    });
  }

  function openSettings(){
    const storeInput = el('#set-store-name');
    if(storeInput) storeInput.value = STORE_NAME;

    const txtInput = el('#set-thanks-text');
    if(txtInput){
      const savedTxt = localStorage.getItem(THANKS_TEXT_KEY) || el('#thanks-text').textContent || '';
      txtInput.value = savedTxt;
    }

    const savedImg = localStorage.getItem(THANKS_IMG_KEY);
    const preview = el('#thanks-preview');
    if(preview){
      preview.src = savedImg || el('#thanks-img').src;
    }

    buildSettingsProductsForm();
    gotoPage('#page-settings');
  }

  function handleThanksImgFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        const canvasSmall = el('#thanks-canvas');
        const ctxSmall = canvasSmall.getContext('2d');

        const targetWidth = 256;
        const scale = targetWidth / img.width;
        const w = Math.max(32, Math.round(img.width * scale));
        const h = Math.max(32, Math.round(img.height * scale));
        const smallW = Math.round(w / 4);
        const smallH = Math.round(h / 4);

        canvasSmall.width = smallW;
        canvasSmall.height = smallH;
        ctxSmall.imageSmoothingEnabled = false;
        ctxSmall.drawImage(img, 0, 0, smallW, smallH);

        const imgData = ctxSmall.getImageData(0,0,smallW,smallH);
        const data = imgData.data;
        for(let i=0;i<data.length;i+=4){
          data[i]   = Math.round(data[i]  /64)*64;
          data[i+1] = Math.round(data[i+1]/64)*64;
          data[i+2] = Math.round(data[i+2]/64)*64;
        }
        ctxSmall.putImageData(imgData,0,0);

        const canvasBig = document.createElement('canvas');
        canvasBig.width = w;
        canvasBig.height = h;
        const ctxBig = canvasBig.getContext('2d');
        ctxBig.imageSmoothingEnabled = false;
        ctxBig.drawImage(canvasSmall, 0,0, smallW,smallH, 0,0, w,h);

        const dataUrl = canvasBig.toDataURL('image/png');
        localStorage.setItem(THANKS_IMG_KEY, dataUrl);

        const preview = el('#thanks-preview');
        if(preview) preview.src = dataUrl;
        const thanksImg = el('#thanks-img');
        if(thanksImg) thanksImg.src = dataUrl;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // ---- éµç›¤æ§åˆ¶ ----
  let firstUserInteractionDone = false;

  document.addEventListener('keydown', async (e)=>{
    // å¯†ç¢¼è¦–çª—é–‹å•Ÿæ™‚ï¼Œå„ªå…ˆè™•ç† Enter / Esc
    if (isPwModalOpen()) {
      if (e.key === 'Enter' || e.code === 'NumpadEnter') {
        e.preventDefault();
        handlePwSubmit();
        return;
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        hidePwModal();
        return;
      }
      return; // å…¶ä»–éµè®“ input è‡ªå·±è™•ç†
    }

    if (!(e.key === 'Enter' || e.code === 'NumpadEnter')) {
      playAudioById('#key');
    }

    if(!firstUserInteractionDone){
      firstUserInteractionDone = true;
      try{ await requestFullscreen(); }catch(_){}
    }

    if(e.key === ' '){
      e.preventDefault();
    }

    if(e.key.toLowerCase() === 't'){
      showToast();
      return;
    }

    const resultShown = !el('#result').classList.contains('hidden');
    const thanksShown = el('#thanks-modal').classList.contains('show');

    // Insertï¼šæŸ¥çœ‹æ­·å² / è¿”å›ä¸»é 
    if (e.key === 'Insert' || e.code === 'Insert') {
      e.preventDefault();
      if (onHistoryPage()) {
        gotoPage('#page-products');
      } else {
        gotoHistory();
      }
      return;
    }

    // Alt+Enter åˆ‡æ›å…¨è¢å¹•
    if(e.altKey && e.key === 'Enter'){
      try{ await toggleFullscreen(); }catch(_){}
      return;
    }

    // è¨­å®šé ä¸åƒå¿«æ·éµï¼ˆé¿å…èª¤è§¸ï¼‰
    if(onSettingsPage()){
      return;
    }

    // ===== å•†å“é  =====
    if(onProductsPage()){
      if(e.key === 'ArrowUp'){
        e.preventDefault();
        selectPrev();
      }else if(e.key === 'ArrowDown'){
        e.preventDefault();
        selectNext();
      }else if(e.key === 'ArrowLeft'){
        e.preventDefault();
        decreaseQty();
      }else if(e.key === 'ArrowRight'){
        e.preventDefault();
        increaseQty();
      }else if(e.key === 'Enter' || e.code === 'NumpadEnter'){
        e.preventDefault();
        playAudioById('#enterSound');
        enterPayPage();
      }
      return;
    }

    // ===== ä»˜æ¬¾é  =====
    if(onPayPage()){
      const inp = el('#cash-input');

      if (/^[0-9]$/.test(e.key)) {
        e.preventDefault();
        inp.value = String(inp.value || '') + e.key;
        return;
      }

      if (e.key === 'Backspace') {
        e.preventDefault();
        inp.value = String(inp.value || '').slice(0, -1);
        return;
      }

      const isClearKey =
        e.key === 'Delete' ||
        e.key === 'Clear'  ||
        e.code === 'NumLock' ||
        e.keyCode === 46   ||
        e.keyCode === 12;

      if (isClearKey) {
        e.preventDefault();
        inp.value = '';
        return;
      }

      if(e.key === ' '){
        e.preventDefault();
        inp.value = calcSum();
        return;
      }

      if(e.key === 'Enter' || e.code === 'NumpadEnter'){
        e.preventDefault();

        const sum = calcSum();
        const received = Number(el('#cash-input').value||0);

        if(!resultShown && !thanksShown){
          playAudioById('#enterSound');
          showResultModal(sum, received);
        }else if(resultShown && !thanksShown){
          if(received < sum){
            playAudioById('#enterSound');
            showResultModal(sum, received);
            return;
          }
          playAudioById('#enterFinal');
          finishCheckout();
        }else if(thanksShown){
          playAudioById('#enterSound');
          hideThanksModal();
          returnHome();
        }
        return;
      }

      if(e.key.toLowerCase() === 'f'){
        e.preventDefault();
        const sum = calcSum();
        const received = Number(el('#cash-input').value||0);
        if(received < sum){
          playAudioById('#enterSound');
          showResultModal(sum, received);
          return;
        }
        playAudioById('#enterFinal');
        finishCheckout();
        return;
      }

      if(e.key === 'Escape'){
        e.preventDefault();
        gotoPage('#page-products');
        return;
      }
    }
  });

  // æ•¸å­—å°éµç›¤åŠ å€¼
  document.addEventListener('keydown', e=>{
    if(onPayPage()){
      if(e.code === 'NumpadAdd'){
        e.preventDefault();
        el('[data-cash="100"]').click();
      }else if(e.code === 'NumpadMultiply'){
        e.preventDefault();
        el('[data-cash="500"]').click();
      }else if(e.code === 'NumpadDivide'){
        e.preventDefault();
        el('[data-cash="1000"]').click();
      }else if(e.code === 'NumpadSubtract'){
        e.preventDefault();
        el('[data-cash="exact"]').click();
      }
    }
  });

  // ==== DOMContentLoaded ====
  window.addEventListener('DOMContentLoaded', ()=>{
    document.title = `${STORE_NAME}ãƒ»æ”¶éŠ€ç³»çµ±`;
    applyThanksConfig();

    renderList();
    refreshTodayStats();
    startClock();

    // å°è¨ˆ â†’ ä»˜æ¬¾é 
    el('#btn-subtotal').addEventListener('click', ()=> {
      playAudioById('#enterSound');
      enterPayPage();
    });

    // å¿«æ·é‡‘é¡
    els('.quick button').forEach(b=> b.addEventListener('click', ()=>{
      const sum = calcSum();
      const v = b.dataset.cash;
      let curr = Number(el('#cash-input').value||0);
      if(v==='exact'){ curr = sum; } else { curr += Number(v||0); }
      el('#cash-input').value = curr;
    }));

    // ä»˜æ¬¾æµç¨‹æŒ‰éˆ•
    el('#btn-confirm').addEventListener('click', ()=>{
      const sum = calcSum();
      const received = Number(el('#cash-input').value||0);
      playAudioById('#enterSound');
      showResultModal(sum, received);
    });

    el('#btn-finish').addEventListener('click', ()=>{
      const sum = calcSum();
      const received = Number(el('#cash-input').value||0);
      if(received < sum){
        showResultModal(sum, received);
        return;
      }
      playAudioById('#enterFinal');
      finishCheckout();
    });

    el('#btn-back').addEventListener('click', ()=> gotoPage('#page-products'));

    // æ­·å²æŒ‰éˆ•
    el('#btn-history').addEventListener('click', gotoHistory);
    el('#btn-h-back').addEventListener('click', ()=> gotoPage('#page-products'));

    // æ—¥æœŸç¯©é¸
    const dateInput = el('#history-date');
    const dateClear = el('#btn-date-clear');
    if(dateInput){
      dateInput.addEventListener('change', ()=>{
        setHistoryFilter(dateInput.value || null);
      });
    }
    if(dateClear){
      dateClear.addEventListener('click', ()=>{
        if(dateInput) dateInput.value = '';
        setHistoryFilter(null);
      });
    }

    // åŒ¯å‡º / æ¸…ç©ºæ­·å²
    el('#btn-export').addEventListener('click', exportCSV);
    el('#btn-clear-all').addEventListener('click', ()=>{
      const arr = loadAll();
      if(!arr.length){ showToast('ç›®å‰æ²’æœ‰ç´€éŒ„'); return; }
      if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ')){
        saveAll([]); renderHistory(); refreshTodayStats(); showToast('å·²æ¸…ç©º');
      }
    });

    // å…¨è¢å¹•æŒ‰éˆ•
    el('#btn-fs').addEventListener('click', async ()=>{
      try{ await toggleFullscreen(); }catch(_){}
    });

    // æ„Ÿè¬è¦–çª—é—œé–‰
    el('#thanks-close').addEventListener('click', ()=>{
      hideThanksModal();
      returnHome();
    });

    // ğŸ” è¨­å®šé ï¼ˆDOS é¢¨æ ¼å¯†ç¢¼è¦–çª—ï¼‰
    el('#btn-settings').addEventListener('click', () => {
      showPwModal();
    });

    el('#pw-ok').addEventListener('click', () => {
      handlePwSubmit();
    });
    el('#pw-cancel').addEventListener('click', () => {
      hidePwModal();
    });

    const pwInput = el('#pw-input');
    if (pwInput) {
      pwInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.code === 'NumpadEnter') {
          e.preventDefault();
          handlePwSubmit();
        }
      });
    }

    // å„²å­˜è¨­å®š
    el('#btn-settings-cancel').addEventListener('click', ()=> gotoPage('#page-products'));

    el('#btn-settings-save').addEventListener('click', ()=>{
      // åº—å
      const storeInput = el('#set-store-name');
      let newName = storeInput ? storeInput.value.trim() : '';
      if(!newName) newName = DEFAULT_STORE_NAME;
      STORE_NAME = newName;
      saveStoreName(STORE_NAME);
      document.title = `${STORE_NAME}ãƒ»æ”¶éŠ€ç³»çµ±`;

      // å•†å“
      const nameInputs  = Array.from(document.querySelectorAll('.set-p-name'));
      const priceInputs = Array.from(document.querySelectorAll('.set-p-price'));
      const newProducts = [];
      nameInputs.forEach((inp, i)=>{
        const n = inp.value.trim();
        const p = Number(priceInputs[i].value||0);
        if(!n) return;
        if(p <= 0) return;
        newProducts.push({name:n, price:p, qty:0});
      });
      if(!newProducts.length){
        alert('è‡³å°‘éœ€è¦ä¸€å€‹å•†å“');
        return;
      }
      PRODUCTS = newProducts;
      saveProducts(PRODUCTS);
      selectedIndex = 0;
      renderList();

      // æ„Ÿè¬æ–‡å­—
      const txtInput = el('#set-thanks-text');
      const t = txtInput ? txtInput.value.trim() : '';
      const finalText = t || 'è¬è¬æ‚¨çš„å…‰é¡§ï¼Œæ­¡è¿ä¸‹æ¬¡å†ä¾†ï¼';
      localStorage.setItem(THANKS_TEXT_KEY, finalText);
      el('#thanks-text').textContent = finalText;

      gotoPage('#page-products');
      showToast('å·²å„²å­˜è¨­å®š');
    });

    // æ–°å¢å•†å“
    el('#btn-add-product').addEventListener('click', ()=>{
      PRODUCTS.push({name:'', price:0, qty:0});
      buildSettingsProductsForm();
    });

    // æ„Ÿè¬åœ–ç‰‡ä¸Šå‚³
    const imgInput = el('#set-thanks-img');
    if(imgInput){
      imgInput.addEventListener('change', e=>{
        const file = e.target.files[0];
        handleThanksImgFile(file);
      });
    }

    // PWA service worker
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js');
    }
  });
  </script>
</body>
</html>
